# Documento de Evolu√ß√£o da Aplica√ß√£o "Leitor Inteligente"

Este documento detalha as estrat√©gias t√©cnicas para implementa√ß√£o das melhorias solicitadas, visando a evolu√ß√£o da aplica√ß√£o atual (Streamlit + FastAPI) para um sistema mais robusto, interativo e completo.

## Vis√£o Geral das Mudan√ßas

A aplica√ß√£o passar√° de um visualizador passivo para um sistema completo de gest√£o de processos periciais, incluindo cadastro, controle de acesso e an√°lise detalhada de evid√™ncias com persist√™ncia em banco de dados.

---

## Estrat√©gias de Implementa√ß√£o por Item

### 1. Melhoria da Visualiza√ß√£o em P√°gina Inteira do PDF
**Objetivo:** Resolver a restri√ß√£o de visualiza√ß√£o do PDF criando um modo de "Foco".
**Estrat√©gia T√©cnica:**
- **Frontend (Streamlit):**
    - Implementar um controle de estado (`st.session_state['modo_visualizacao']` = 'padrao' | 'foco').
    - Adicionar um bot√£o "Expandir PDF" na barra de ferramentas do visualizador.
    - **L√≥gica de Layout Condicional:**
        - **Modo Padr√£o:** Manter layout de duas colunas (`st.columns([1, 1])`).
        - **Modo Foco:** Ocultar a coluna de evid√™ncias e filtros, renderizando o iframe do PDF ocupando toda a largura dispon√≠vel.
    - Adicionar bot√£o "Restaurar Vis√£o" flutuante ou no topo para voltar ao modo padr√£o.

### 2. Etapa de Cadastro do Processo
**Objetivo:** Permitir o upload e registro de novos processos e suas evid√™ncias diretamente pela interface.
**Estrat√©gia T√©cnica:**
- **Frontend:**
    - Criar uma nova p√°gina ou aba "Novo Processo".
    - Formul√°rio contendo:
        - Campos textuais: `N√∫mero do Processo`, `Descri√ß√£o/Nome`.
        - Uploaders: `Arquivo PDF` (Obrigat√≥rio), `Planilha Mapeamento` (Opcional), `Planilha Catalogador` (Opcional).
    - Bot√£o "Cadastrar Processo".
- **Backend (FastAPI):**
    - Criar endpoint `POST /processos` (multipar/form-data).
    - Receber metadados e arquivos simultaneamente.
    - **Actions:**
        1. Criar registro na tabela `processos`.
        2. Salvar PDF em `/static/uploads`.
        3. Trigger autom√°tico das fun√ß√µes de ETL (`import_mapeamento`, `import_catalogador`) para processar as planilhas em mem√≥ria e salvar no banco.

### 3. Busca de Processo Cadastrado
**Objetivo:** Facilitar a localiza√ß√£o de processos j√° inseridos.
**Estrat√©gia T√©cnica:**
- **Frontend:**
    - O componente `st.sidebar.selectbox` j√° possui busca textual nativa.
    - **Melhoria:** Se o n√∫mero de processos for muito grande, implementar "Lazy Loading" ou um campo de texto "Filtrar Processos" acima do selectbox para filtrar a lista antes de carregar no componente de sele√ß√£o.

### 4. Armazenamento Autom√°tico (Fluxo de Cadastro)
**Objetivo:** Automatizar a carga de dados no momento do cadastro.
**Estrat√©gia T√©cnica:**
- **Backend:**
    - Como descrito no item 2, a l√≥gica de ETL (`etl_service.py`) ser√° invocada diretamente pelo endpoint de cadastro.
    - Isso elimina a necessidade de scripts manuais (`seed_db.py` ou execu√ß√£o via terminal) para opera√ß√£o normal, tornando o sistema "Self-Service" para o usu√°rio final.

### 5. Cadastro de Login e Permiss√µes (Admin)
**Objetivo:** Controle de acesso e seguran√ßa b√°sica.
**Estrat√©gia T√©cnica:**
- **Banco de Dados:**
    - Criar tabela `usuarios` com colunas: `username` (PK), `password_hash`, `is_admin`, `can_create_users`.
- **Backend:**
    - Endpoint `POST /token` para autentica√ß√£o (retornando JWT ou valida√ß√£o simples).
    - Endpoint `POST /users` para criar usu√°rios (protegido, requer admin).
- **Frontend:**
    - Implementar fluxo de Login: Checar `st.session_state['token']`. Se vazio, mostrar apenas tela de Login.
    - **Menu Admin:** Criar se√ß√£o na sidebar vis√≠vel apenas se `user.is_admin == True` para gest√£o de usu√°rios.
    - **Seed Inicial:** Garantir cria√ß√£o autom√°tica do usu√°rio `admin` / `admin` na inicializa√ß√£o do banco.

### 6. Filtro "Tipo de Evid√™ncia" Din√¢mico
**Objetivo:** Mostrar apenas tipos de evid√™ncia existentes no processo atual.
**Estrat√©gia T√©cnica:**
- **Backend:**
    - Criar endpoint `GET /processos/{id}/tipos_evidencia`.
    - Query: `SELECT DISTINCT tipo_evidencia FROM evidencias_mapeadas WHERE processo_id = :id UNION SELECT DISTINCT origem_tipo FROM evidencias_catalogadas...`
- **Frontend:**
    - Ao selecionar um processo, chamar este endpoint e popular o `st.selectbox` de filtro com os valores retornados.

### 7. Organiza√ß√£o dos Filtros (Bloco Evid√™ncias)
**Objetivo:** Melhorar a UX movendo filtros para perto da lista de resultados.
**Estrat√©gia T√©cnica:**
- **Frontend:**
    - Remover filtros da Sidebar.
    - Inserir os campos de "Busca Textual" e "Tipo de Evid√™ncia" no topo da **Coluna Esquerda**, logo acima da lista de cards de evid√™ncia. Isso contextualiza a busca.

### 8. Visualiza√ß√£o do Trecho Completo
**Objetivo:** Eliminar o corte de texto na visualiza√ß√£o do "Trecho".
**Estrat√©gia T√©cnica:**
- **Backend:**
    - Garantir que o schema de resposta (`EvidenciaUnificada`) envie o campo `trecho` completo ou `conteudo` completo na propriedade `original_data`.
- **Frontend:**
    - No card da evid√™ncia, substituir a visualiza√ß√£o truncada por um componente `st.expander("Ver Trecho Completo")` ou um container com scroll, garantindo que todo o texto seja acess√≠vel sem poluir o layout principal.

### 9. Bot√£o "Ver Detalhes" da Evid√™ncia
**Objetivo:** Acesso granular a todas as informa√ß√µes da planilha.
**Estrat√©gia T√©cnica:**
- **Frontend:**
    - Adicionar bot√£o "üìã Detalhes" em cada card de evid√™ncia.
    - A√ß√£o: Abrir um `st.dialog` (modal) exibindo uma tabela ou lista chave-valor com **todos** os dados retornados na chave `original_data` (CNPJ, Datas, Valores, CFOP, Refer√™ncias Originais, etc.).

### 10. Importa√ß√£o Completa das Planilhas
**Objetivo:** Garantir que nenhuma coluna seja perdida, mesmo que o layout mude.
**Estrat√©gia T√©cnica:**
- **Banco de Dados:**
    - Adicionar coluna do tipo `JSON` chamada `dados_extras` nas tabelas `EvidenciaMapeada` e `EvidenciaCatalogada`.
- **Backend (ETL):**
    - Refatorar `etl_service.py` para ler todas as colunas do Excel.
    - Mapear colunas conhecidas para os campos fixos da tabela.
    - Armazenar **todo o registro (row)** como um dicion√°rio JSON na coluna `dados_extras`.
    - Isso garante "futuro-garantido": qualquer nova coluna adicionada na planilha estar√° automaticamente dispon√≠vel no bot√£o "Ver Detalhes" via leitura do JSON.

---

## Pr√≥ximos Passos
1. Atualizar Modelos de Banco de Dados (`models.py`) para incluir tabela de usu√°rios e campo JSON.
2. Implementar fluxo de Auth (`backend` e `frontend`).
3. Criar endpoint de Cadastro de Processo com Upload e ETL integrado.
4. Refatorar Frontend para novo layout (filtros movidos, modo foco, modais de detalhe).


## Corre√ß√£o de erros e melhorias
- Bot√£o detalhes esta mostrando as informa√ß√µes em estrutura json ou similar, preciso que fique visual para usu√°rio final ou seja, em estrutura de tela
- O bloco "Visualizador PDF"que fica do lado direito da tela ainda est√° cortando o pdf e deixando a pr√© vizualiza√ß√£o incompleta, o ideal seria recolher o bloco "Filtros & Evid√™ncias" assim como √© feito com o bloco "Navega√ß√£o" para que o pdf fique vis√≠vel
